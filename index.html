<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEXRAD Level II Downloader</title>
  <meta name="description" content="Browser-based NEXRAD Level II downloader." />
  <!-- Added JSZip for client-side zipping -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root{
      --bg:#000000; --card:#000000; --muted:#94a3b8; --accent:#ffffff; --accent-2:#e6eef8; --glass:rgba(255,255,255,0.05); --danger: #ef4444; --primary-color: #3b82f6;
      color-scheme: dark; /* Forces native form elements to use dark theme */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:var(--bg);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:28px}
    .wrap{width:900px;max-width:96%;border-radius:14px;padding:22px;background:var(--card);box-shadow:0 10px 30px rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)}
    .header{display:flex;align-items:center;gap:16px}
    .logo{width:44px;height:44px;border-radius:10px;background:white;color:black;display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:20px;margin:0}
    p.lead{color:var(--muted);margin:6px 0 14px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .control{background:var(--card);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)}
    
    /* Native inputs/selects styling */
    input[type=text],select,input[type=date],input[type=time]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:inherit}
    
    /* Validation styling */
    input[type=time].invalid {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
    }
    .error-msg {
        color: var(--danger);
        font-size: 12px;
        margin-top: 6px;
        display: none;
        grid-column: 1/-1;
    }
    
    /* Force options to be dark in supported browsers */
    select option { background-color: #000; color: #fff; }

    .row{display:flex;gap:12px}
    .full{grid-column:1/-1}
    button.primary{background:white;border:none;color:black;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer; transition: opacity 0.2s;}
    button.primary:disabled{opacity: 0.5; cursor: not-allowed;}
    
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.2);color:var(--accent-2);padding:10px;border-radius:8px;cursor:pointer}

    #status{margin-top:14px;color:var(--muted);font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .footer{display:none;}
    a.link{color:var(--accent-2);text-decoration:none}
    
    /* File list specific styles */
    .file-item {
        padding: 8px 0;
        border-bottom: 1px dashed rgba(255,255,255,0.1);
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .file-meta {
        color: var(--muted);
        font-size: 12px;
        margin-left: 10px;
    }

    /* --- Progress Bar Styling --- */
    .progress-wrap {
        grid-column: 1/-1;
        margin-top: 16px;
        display: none; /* Hidden by default */
    }
    .progress-track {
        width: 100%;
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: var(--primary-color);
        width: 0%;
        transition: width 0.1s linear;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }

    /* --- Custom Dropdown Styling --- */
    .custom-select-container {
      position: relative;
      width: 100%;
    }
    .custom-select-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: inherit;
      cursor: pointer;
      user-select: none;
    }
    .custom-select-trigger:after {
      content: "▼";
      font-size: 0.7em;
      margin-left: 10px;
      color: var(--muted);
    }
    .custom-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #000;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-top: 4px;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .custom-options.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .custom-option {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .custom-option:last-child { border-bottom: none; }
    .custom-option:hover {
      background: rgba(255,255,255,0.1);
    }
    .custom-option.selected {
      background: rgba(255,255,255,0.15);
      font-weight: 600;
    }

    /* responsive */
    @media (max-width:720px){.grid{grid-template-columns:1fr}.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">N</div>
      <div>
        <h1>NEXRAD Level II — Downloader (Browser)</h1>
        <p class="lead">Select date, times and radar site.</p>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div>
        <label for="radar">Radar site (4-letter code)</label>
        <input id="radar" type="text" placeholder="KHGX or KBMX" value="KHGX" />
      </div>

      <div>
        <label for="siteList">Or pick from list (CONUS Only)</label>
        <select id="siteList" class="control">
          <option value="">-- select radar --</option>
          <option value="KABR">KABR – Aberdeen, SD</option>
          <option value="KABX">KABX – Albuquerque, NM</option>
          <option value="KAKQ">KAKQ – Wakefield, VA</option>
          <option value="KAMA">KAMA – Amarillo, TX</option>
          <option value="KAMX">KAMX – Miami, FL</option>
          <option value="KAPX">KAPX – Gaylord, MI</option>
          <option value="KARX">KARX – La Crosse, WI</option>
          <option value="KATX">KATX – Seattle, WA</option>
          <option value="KBBX">KBBX – Beale AFB, CA</option>
          <option value="KBGM">KBGM – Binghamton, NY</option>
          <option value="KBHX">KBHX – Eureka, CA</option>
          <option value="KBIS">KBIS – Bismarck, ND</option>
          <option value="KBLX">KBLX – Billings, MT</option>
          <option value="KBMX">KBMX – Birmingham, AL</option>
          <option value="KBOX">KBOX – Boston, MA</option>
          <option value="KBRO">KBRO – Brownsville, TX</option>
          <option value="KBUF">KBUF – Buffalo, NY</option>
          <option value="KBYX">KBYX – Key West, FL</option>
          <option value="KCAE">KCAE – Columbia, SC</option>
          <option value="KCBW">KCBW – Caribou, ME</option>
          <option value="KCBX">KCBX – Boise, ID</option>
          <option value="KCCX">KCCX – State College, PA</option>
          <option value="KCLE">KCLE – Cleveland, OH</option>
          <option value="KCLX">KCLX – Charleston, SC</option>
          <option value="KCRP">KCRP – Corpus Christi, TX</option>
          <option value="KCXX">KCXX – Burlington, VT</option>
          <option value="KCYS">KCYS – Cheyenne, WY</option>
          <option value="KDAX">KDAX – Sacramento, CA</option>
          <option value="KDDC">KDDC – Dodge City, KS</option>
          <option value="KDFX">KDFX – Laughlin AFB, TX</option>
          <option value="KDGX">KDGX – Jackson, MS</option>
          <option value="KDIX">KDIX – Philadelphia, NJ</option>
          <option value="KDLH">KDLH – Duluth, MN</option>
          <option value="KDMX">KDMX – Des Moines, IA</option>
          <option value="KDOX">KDOX – Dover AFB, DE</option>
          <option value="KDTX">KDTX – Detroit, MI</option>
          <option value="KDVN">KDVN – Davenport, IA</option>
          <option value="KDYX">KDYX – Abilene/Dyess AFB, TX</option>
          <option value="KEAX">KEAX – Kansas City, MO</option>
          <option value="KEMX">KEMX – Tucson, AZ</option>
          <option value="KENX">KENX – Albany, NY</option>
          <option value="KEOX">KEOX – Ft. Rucker, AL</option>
          <option value="KEPZ">KEPZ – El Paso, TX</option>
          <option value="KESX">KESX – Las Vegas, NV</option>
          <option value="KEVX">KEVX – Eglin AFB, FL</option>
          <option value="KEWX">KEWX – Austin/San Antonio, TX</option>
          <option value="KEYX">KEYX – Edwards AFB, CA</option>
          <option value="KFCX">KFCX – Roanoke, VA</option>
          <option value="KFDR">KFDR – Frederick, OK</option>
          <option value="KFDX">KFDX – Cannon AFB, NM</option>
          <option value="KFFC">KFFC – Atlanta, GA</option>
          <option value="KFSD">KFSD – Sioux Falls, SD</option>
          <option value="KFSX">KFSX – Flagstaff, AZ</option>
          <option value="KFWS">KFWS – Dallas/Fort Worth, TX</option>
          <option value="KGGW">KGGW – Glasgow, MT</option>
          <option value="KGJX">KGJX – Grand Junction, CO</option>
          <option value="KGLD">KGLD – Goodland, KS</option>
          <option value="KGRB">KGRB – Green Bay, WI</option>
          <option value="KGRK">KGRK – Ft. Hood, TX</option>
          <option value="KGRR">KGRR – Grand Rapids, MI</option>
          <option value="KGSP">KGSP – Greenville, SC</option>
          <option value="KGWX">KGWX – Columbus AFB, MS</option>
          <option value="KGYX">KGYX – Portland, ME</option>
          <option value="KHDX">KHDX – Holloman AFB, NM</option>
          <option value="KHGX">KHGX – Houston, TX</option>
          <option value="KHNX">KHNX – Hanford, CA</option>
          <option value="KHPX">KHPX – Fort Campbell, KY</option>
          <option value="KHTX">KHTX – Huntsville, AL</option>
          <option value="KICT">KICT – Wichita, KS</option>
          <option value="KICX">KICX – Cedar City, UT</option>
          <option value="KILN">KILN – Cincinnati, OH</option>
          <option value="KILX">KILX – Lincoln, IL</option>
          <option value="KIND">KIND – Indianapolis, IN</option>
          <option value="KINX">KINX – Tulsa, OK</option>
          <option value="KIWA">KIWA – Phoenix, AZ</option>
          <option value="KIWX">KIWX – Northern Indiana</option>
          <option value="KJAX">KJAX – Jacksonville, FL</option>
          <option value="KJGX">KJGX – Robins AFB, GA</option>
          <option value="KJKL">KJKL – Jackson, KY</option>
          <option value="KLBB">KLBB – Lubbock, TX</option>
          <option value="KLCH">KLCH – Lake Charles, LA</option>
          <option value="KLGX">KLGX – Langley Hill, WA</option>
          <option value="KLIX">KLIX – New Orleans, LA</option>
          <option value="KLNX">KLNX – North Platte, NE</option>
          <option value="KLOT">KLOT – Chicago, IL</option>
          <option value="KLRX">KLRX – Elko, NV</option>
          <option value="KLSX">KLSX – St. Louis, MO</option>
          <option value="KLTX">KLTX – Wilmington, NC</option>
          <option value="KLVX">KLVX – Louisville, KY</option>
          <option value="KLWX">KLWX – Sterling, VA</option>
          <option value="KLZK">KLZK – Little Rock, AR</option>
          <option value="KMAF">KMAF – Midland/Odessa, TX</option>
          <option value="KMAX">KMAX – Medford, OR</option>
          <option value="KMBX">KMBX – Minot AFB, ND</option>
          <option value="KMHX">KMHX – Morehead City, NC</option>
          <option value="KMKX">KMKX – Milwaukee, WI</option>
          <option value="KMLB">KMLB – Melbourne, FL</option>
          <option value="KMOB">KMOB – Mobile, AL</option>
          <option value="KMPX">KMPX – Minneapolis, MN</option>
          <option value="KMQT">KMQT – Marquette, MI</option>
          <option value="KMRX">KMRX – Knoxville, TN</option>
          <option value="KMSX">KMSX – Missoula, MT</option>
          <option value="KMTX">KMTX – Salt Lake City, UT</option>
          <option value="KMUX">KMUX – San Francisco, CA</option>
          <option value="KMVX">KMVX – Grand Forks, ND</option>
          <option value="KMXX">KMXX – Maxwell AFB, AL</option>
          <option value="KNKX">KNKX – San Diego, CA</option>
          <option value="KNQA">KNQA – Memphis, TN</option>
          <option value="KOAX">KOAX – Omaha, NE</option>
          <option value="KOHX">KOHX – Nashville, TN</option>
          <option value="KOKX">KOKX – Upton, NY</option>
          <option value="KOTX">KOTX – Spokane, WA</option>
          <option value="KPAH">KPAH – Paducah, KY</option>
          <option value="KPBZ">KPBZ – Pittsburgh, PA</option>
          <option value="KPDT">KPDT – Pendleton, OR</option>
          <option value="KPOE">KPOE – Fort Polk, LA</option>
          <option value="KPUX">KPUX – Pueblo, CO</option>
          <option value="KRAX">KRAX – Raleigh/Durham, NC</option>
          <option value="KRGX">KRGX – Reno, NV</option>
          <option value="KRIW">KRIW – Riverton, WY</option>
          <option value="KRLX">KRLX – Charleston, WV</option>
          <option value="KRTX">KRTX – Portland, OR</option>
          <option value="KSFX">KSFX – Pocatello, ID</option>
          <option value="KSGF">KSGF – Springfield, MO</option>
          <option value="KSHV">KSHV – Shreveport, LA</option>
          <option value="KSJT">KSJT – San Angelo, TX</option>
          <option value="KSOX">KSOX – Santa Ana, CA</option>
          <option value="KSRX">KSRX – Fort Smith, AR</option>
          <option value="KTBW">KTBW – Tampa, FL</option>
          <option value="KTFX">KTFX – Great Falls, MT</option>
          <option value="KTLH">KTLH – Tallahassee, FL</option>
          <option value="KTLX">KTLX – Oklahoma City, OK</option>
          <option value="KTQX">KTQX – Tuscaloosa, AL</option>
          <option value="KTWX">KTWX – Topeka, KS</option>
          <option value="KTYX">KTYX – Fort Drum, NY</option>
          <option value="KUDX">KUDX – Rapid City, SD</option>
          <option value="KUEX">KUEX – Hastings, NE</option>
          <option value="KVAX">KVAX – Valdosta, GA</option>
          <option value="KVBX">KVBX – Vandenberg AFB, CA</option>
          <option value="KVNX">KVNX – Vance AFB, OK</option>
          <option value="KVWX">KVWX – Evansville, IN</option>
          <option value="KYUX">KYUX – Yuma, AZ</option>
        </select>
      </div>

      <div>
        <label for="month">Date</label>
        <div class="row">
          <select id="month" class="control">
            <option value="01">Jan</option>
            <option value="02">Feb</option>
            <option value="03">Mar</option>
            <option value="04">Apr</option>
            <option value="05">May</option>
            <option value="06">Jun</option>
            <option value="07">Jul</option>
            <option value="08">Aug</option>
            <option value="09">Sep</option>
            <option value="10">Oct</option>
            <option value="11">Nov</option>
            <option value="12">Dec</option>
          </select>
          <select id="day" class="control">
            <option value="01">1</option>
            <option value="02">2</option>
            <option value="03">3</option>
            <option value="04">4</option>
            <option value="05">5</option>
            <option value="06">6</option>
            <option value="07">7</option>
            <option value="08">8</option>
            <option value="09">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
          </select>
          <select id="year" class="control">
            <option value="1991">1991</option>
            <option value="1992">1992</option>
            <option value="1993">1993</option>
            <option value="1994">1994</option>
            <option value="1995">1995</option>
            <option value="1996">1996</option>
            <option value="1997">1997</option>
            <option value="1998">1998</option>
            <option value="1999">1999</option>
            <option value="2000">2000</option>
            <option value="2001">2001</option>
            <option value="2002">2002</option>
            <option value="2003">2003</option>
            <option value="2004">2004</option>
            <option value="2005">2005</option>
            <option value="2006">2006</option>
            <option value="2007">2007</option>
            <option value="2008">2008</option>
            <option value="2009">2009</option>
            <option value="2010">2010</option>
            <option value="2011">2011</option>
            <option value="2012">2012</option>
            <option value="2013">2013</option>
            <option value="2014">2014</option>
            <option value="2015">2015</option>
            <option value="2016">2016</option>
            <option value="2017">2017</option>
            <option value="2018">2018</option>
            <option value="2019">2019</option>
            <option value="2020">2020</option>
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>
        </div>
      </div>

      <div>
        <label for="timezoneNote" style="margin-bottom:0">Time (local)</label>
        <div class="row" style="margin-top:6px">
          <div style="flex:1">
            <label class="small">Start</label>
            <input id="startTime" type="time" value="00:00" required />
          </div>
          <div style="flex:1">
            <label class="small">End</label>
            <input id="endTime" type="time" value="23:59" required />
          </div>
        </div>
        <div id="timeError" class="error-msg">End time cannot be before start time.</div>
      </div>

      <div class="full">
        <label for="downloadMode">Download mode</label>
        <!-- Custom Dropdown Structure -->
        <div class="custom-select-container" id="customDownloadMode">
          <div class="custom-select-trigger">Only show file list (no auto-download)</div>
          <div class="custom-options">
            <div class="custom-option selected" data-value="list">Only show file list (no auto-download)</div>
            <div class="custom-option" data-value="zip">Download as ZIP archive</div>
          </div>
        </div>
        <!-- Hidden input to maintain compatibility with logic - DEFAULT TO LIST -->
        <input type="hidden" id="downloadMode" value="list">
      </div>

      <div class="full small">
        <label>Notes</label>
        <div class="control small">This runs fully client-side and fetches the public S3 index. <strong>Download as ZIP</strong> will fetch all selected files into memory and compress them before prompting for a single download. Use "Only show file list" to inspect before downloading.</div>
      </div>

      <div class="full" style="display:flex;gap:12px;margin-top:10px">
        <button id="downloadBtn" class="primary">Execute</button>
      </div>

      <!-- Added Progress Bar Container -->
      <div id="progressContainer" class="progress-wrap">
        <div class="progress-track">
            <div id="progressBar" class="progress-fill"></div>
        </div>
      </div>

      <div class="full" id="status">Idle</div>
    </div>

    <div class="footer">
    </div>
  </div>

  <script>
    // Custom Dropdown Logic
    const customSelect = document.getElementById('customDownloadMode');
    const trigger = customSelect.querySelector('.custom-select-trigger');
    const optionsContainer = customSelect.querySelector('.custom-options');
    const options = customSelect.querySelectorAll('.custom-option');
    const hiddenInput = document.getElementById('downloadMode');

    // Toggle dropdown
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      optionsContainer.classList.toggle('open');
    });

    // Handle selection
    options.forEach(option => {
      option.addEventListener('click', () => {
        // Update styling
        options.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        
        // Update trigger text and hidden input value
        trigger.textContent = option.textContent;
        hiddenInput.value = option.getAttribute('data-value');
        
        // Close dropdown
        optionsContainer.classList.remove('open');
      });
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      if (!customSelect.contains(e.target)) {
        optionsContainer.classList.remove('open');
      }
    });

    // --- TIME VALIDATION LOGIC ---
    const startInput = document.getElementById('startTime');
    const endInput = document.getElementById('endTime');
    const timeError = document.getElementById('timeError');
    const dlBtn = document.getElementById('downloadBtn');

    function validateTime() {
        const s = startInput.value;
        const e = endInput.value;

        // 1. Update the 'min' constraint on the End Time input
        // This prevents users from picking an earlier time in the native picker
        endInput.min = s;

        // 2. Manual Validation (Visual Feedback)
        // If user typed manually or constraint failed
        if (s && e && s > e) {
            endInput.classList.add('invalid');
            timeError.style.display = 'block';
            dlBtn.disabled = true;
        } else {
            endInput.classList.remove('invalid');
            timeError.style.display = 'none';
            dlBtn.disabled = false;
        }
    }

    startInput.addEventListener('input', validateTime);
    endInput.addEventListener('input', validateTime);
    
    // Initial check
    validateTime();
    // -----------------------------


    // Public NEXRAD S3 bucket base
    const BUCKET = "https://unidata-nexrad-level2.s3.amazonaws.com/";
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');

    function pad(n){return String(n).padStart(2,'0')}

    // parse filename timestamp like KHGX20220322_120125_V06 (Time is UTC)
    function parseTimestamp(name){
      try{
        const [a,b] = name.split('_');
        const date = a.slice(-8); // 20220322
        const time = b.slice(0,6); // 120125
        
        // Explicitly create UTC date
        const y = parseInt(date.slice(0,4));
        const m = parseInt(date.slice(4,6)) - 1; // Month is 0-indexed
        const d = parseInt(date.slice(6,8));
        const H = parseInt(time.slice(0,2));
        const M = parseInt(time.slice(2,4));
        const S = parseInt(time.slice(4,6));

        return new Date(Date.UTC(y, m, d, H, M, S));
      }catch(e){return null}
    }

    // format bytes to MB
    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // list objects by prefix using S3 ListObjectsV2 (returns XML)
    // Modified to extract Size
    async function listFolder(prefix){
      const url = `${BUCKET}?list-type=2&prefix=${encodeURIComponent(prefix)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`Failed listing: ${res.status}`);
      const xml = await res.text();
      const doc = new DOMParser().parseFromString(xml,'text/xml');
      const contents = [...doc.getElementsByTagName('Contents')];
      
      // Map contents to extract Key and Size
      return contents.map(node => {
          return {
              key: node.getElementsByTagName('Key')[0].textContent,
              size: Number(node.getElementsByTagName('Size')[0].textContent)
          };
      });
    }

    // create invisible link to trigger browser download
    function triggerDownload(url, filename){
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // combine date + time strings into Date object
    function combineDateTime(dateStr,timeStr){
      const d = new Date(dateStr);
      const [hh,mm] = timeStr.split(':');
      d.setHours(Number(hh),Number(mm),0,0);
      return d;
    }

    document.getElementById('siteList').addEventListener('change', e=>{
      const v = e.target.value;
      if(v) document.getElementById('radar').value = v;
    });

    async function gatherAndMaybeDownload({mode}){
      const radar = document.getElementById('radar').value.trim().toUpperCase();
      const yyyy = document.getElementById('year').value;
      const mm = document.getElementById('month').value;
      const dd = document.getElementById('day').value;
      const date = `${yyyy}-${mm}-${dd}`;
      const startT = document.getElementById('startTime').value || '00:00';
      const endT = document.getElementById('endTime').value || '23:59';
      const statusEl = document.getElementById('status');

      // Reset progress UI
      progressContainer.style.display = 'none';
      progressBar.style.width = '0%';

      if(!radar || radar.length!==4){alert('Radar must be a 4-letter station code (e.g., KHGX)');return}
      if(!date){alert('Please pick a date');return}

      const startDT = combineDateTime(date,startT);
      const endDT = combineDateTime(date,endT);
      if(endDT < startDT){alert('End time must be after start time');return}

      statusEl.textContent = 'Listing files for '+radar+' on '+date+' ...';

      const y = startDT.getFullYear();
      const m = pad(startDT.getMonth()+1);
      const d = pad(startDT.getDate());
      const prefix = `${y}/${m}/${d}/${radar}/`;

      let items = [];
      try{
        items = await listFolder(prefix);
      }catch(err){statusEl.textContent = 'Error listing files: '+err.message; return}

      const matched = [];
      for(const item of items){
        const fname = item.key.split('/').pop();

        // STRICT CHECK: Ensure the file actually starts with the requested Radar ID
        // This ignores stray index.html or metadata files sometimes found in the bucket
        if (!fname.startsWith(radar)) continue;

        const dt = parseTimestamp(fname);
        if(dt && dt>=startDT && dt<=endDT){ 
            matched.push({
                key: item.key, 
                name: fname, 
                dt: dt, 
                size: item.size 
            }); 
        }
      }

      matched.sort((a,b)=>a.dt-b.dt);

      if(mode==='list'){
        statusEl.innerHTML = `Found ${matched.length} files — showing list.`;
        // show a simple file list that user can click to download individually
        const listHtml = matched.map(x => {
            const timeStr = x.dt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit', timeZoneName: 'short'});
            return `
            <div class="file-item">
                <div>
                    <a class='link' href='${BUCKET+encodeURIComponent(x.key)}' target='_blank'>${x.name}</a>
                </div>
                <div class="file-meta">
                    ${formatSize(x.size)} | ${timeStr}
                </div>
            </div>`;
        }).join('');
        
        statusEl.innerHTML += '<div style="margin-top:10px;max-height:260px;overflow:auto;padding:10px;background:var(--glass);border-radius:8px">'+listHtml+'</div>';
        return;
      }

      // ZIP download mode (formerly direct)
      // Check for zip/direct compatibility
      if (mode === 'zip' || mode === 'direct') {
        statusEl.textContent = `Preparing to fetch and zip ${matched.length} files...`;
        
        if (matched.length === 0) {
            statusEl.textContent = "No files found to download.";
            return;
        }

        // Show progress bar container
        progressContainer.style.display = 'block';

        const zip = new JSZip();
        let count = 0;
        let failCount = 0;

        for (const item of matched) {
            const fileUrl = BUCKET + item.key;
            statusEl.textContent = `Fetching file ${count + 1} of ${matched.length}: ${item.name} (${formatSize(item.size)})...`;
            
            try {
                // Fetch blob data
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                const blob = await response.blob();
                
                // Add to zip
                zip.file(item.name, blob);
                count++;

                // Update Progress Bar
                const percent = (count / matched.length) * 100;
                progressBar.style.width = percent + '%';

            } catch (err) {
                console.error("Fetch failed for", item.name, err);
                failCount++;
            }
        }

        if (count === 0) {
            statusEl.textContent = "Failed to download any files (possibly CORS restricted).";
            progressContainer.style.display = 'none';
            return;
        }

        statusEl.textContent = `Compressing ${count} files into ZIP archive...`;
        
        try {
            const content = await zip.generateAsync({type: "blob"});
            const zipName = `NEXRAD_${radar}_${date.replace(/-/g,'')}.zip`;
            triggerDownload(URL.createObjectURL(content), zipName);
            statusEl.textContent = `Done! ZIP archive downloaded (${count} files). ${failCount > 0 ? `(${failCount} failed)` : ''}`;
        } catch (err) {
            statusEl.textContent = "Error generating ZIP: " + err.message;
        }
      }
    }

    document.getElementById('downloadBtn').addEventListener('click', ()=>gatherAndMaybeDownload({mode:document.getElementById('downloadMode').value}));

    // initialize selects to today
    (function(){
      const d = new Date();
      document.getElementById('year').value = d.getFullYear();
      document.getElementById('month').value = String(d.getMonth()+1).padStart(2,'0');
      document.getElementById('day').value = String(d.getDate()).padStart(2,'0');
    })();
  </script>
</body>
</html>
